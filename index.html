<!DOCTYPE html>
<html>
	<head>
		<title>SVG TEST</title>
	</head>
	<style>
		canvas { border: solid 1px lightgray; }
	</style>
	<body>
		<script>
			console.dir = function(j) {
				this.log(JSON.parse(JSON.stringify(j)));
			}
		</script>
		<div>physic test</div>
		<div><canvas id="canvas">
			Your browser doesn't appear to support the HTML5 <code>&lt;canvas&gt;</code> element.
		</canvas></div>
		<form id="panel">
	<div>
		<input type="number" name="x_speed" placeholder="X Speed">
		<input type="number" name="y_speed" placeholder="Y Speed">
	</div>
	<div>
		<input type="number" name="x_acc" placeholder="X Acceleration" disabled>
		<input type="number" name="y_acc" placeholder="Y Acceletation (Gravity)" disabled value=0.01>
	</div>
	<div>
		<input type="submit" name="play_btn" value="Play"></button>
	</div>
		</form>
		<script>
			window.requestAnimFrame = (function(callback) {
				return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
				function(callback) {
					setTimeout(callback, 1000 / 60);
				};
			})();

			function Dot(x, y, r) {
				this.x = x;
				this.y = y;
				this.preX = this.x;
				this.preY = this.y;
				this.aX = 0;
				this.aY = 0;
				this.fixX = 0;
				this.fixY = 0;
				this.r = r || 4;
			}
			Dot.prototype.draw = function(ctx, offsetX, offsetY) {
				offsetX = offsetX || 0;
				offsetY = offsetY || 0;
				ctx.beginPath();
				ctx.arc(this.x - offsetX, this.y - offsetY, this.r, 0, Math.PI * 2, true);
				ctx.closePath();
				ctx.fill();
			};

			Dot.prototype.nextPoint = function() {
				var newX, newY;
				newX = this.x * 2 - this.preX + this.aX;
				newY = this.y * 2 - this.preY + this.aY;
				this.preX = this.x + (this.x = newX, 0);
				this.preY = this.y + (this.y = newY, 0);
				return [this.x, this.y];
			};

			function Spring(dot1, dot2, e) {
				var len_x = dot2.x - dot1.x;
				var len_y = dot2.y - dot1.y;
				this.elasticity = e || 0.1; 
				this.dot = [dot1, dot2];
				this.sX = len_x;
				this.sY = len_y;
				this.len = Math.sqrt(Math.pow(len_x, 2) + Math.pow(len_y, 2));
			}

			Spring.prototype.fix = function() {
				var delta_y = this.dot[1].y - this.dot[0].y;
				var delta_x = this.dot[1].x - this.dot[0].x;
				var delta = Math.sqrt(Math.pow(delta_x, 2) + Math.pow(delta_y, 2));
				var fix_y, fix_x;
				if(delta < 1) {
					delta = 1;
				}
				fix_y = (delta_y * this.len / delta - delta_y) / 4 * this.elasticity;
				fix_x = (delta_x * this.len / delta - delta_x) / 4 * this.elasticity;
				this.dot[0].fixY -= fix_y;
				this.dot[1].fixY += fix_y;
				this.dot[0].fixX -= fix_x;
				this.dot[1].fixX += fix_x;
			};

			Spring.prototype.draw = function(ctx, offsetX, offsetY) {
				offsetX = offsetX || 0;
				offsetY = offsetY || 0;
				ctx.moveTo(this.dot[0].x - offsetX, this.dot[0].y - offsetY);
				ctx.lineTo(this.dot[1].x - offsetX, this.dot[1].y - offsetY);
				ctx.stroke();
			};

			(function() {
				var c = document.getElementById('canvas');
				var ctx = c.getContext('2d');
				var dot_list = [];
				var spring_list = [];
				var form = document.getElementById('panel');
				var stop = true;
				var redraw_area= [0, 0, 0, 0];
				var r = 3; 
				var frames = [];
				var buffer = 1200;
				c.height = 1000;
				c.width = 1000;
				
				function drawFrame(dots, springs) {
					var preCanvas = document.createElement('canvas');
					var preCtx = preCanvas.getContext("2d");
					var x_list = [];
					var y_list = [];
					var max_X, max_Y, min_X, min_Y;
					var res = [];
					dots.forEach(function(dot){
						var delta, delta_wall;
						var delta_t;
						dot.nextPoint();
						dot.x = Math.min(Math.max(dot.x, 0), c.width);
						dot.y = Math.min(Math.max(dot.y, 0), c.height);
					});

					springs.forEach(function(spring) {
						spring.fix();
					});

					dots.forEach(function(dot){
						var reflectX, reflectY;
						dot.x += dot.fixX;
						dot.y += dot.fixY;
						dot.fixX = 0
						dot.fixY = 0
						reflectX = dot.x;
						reflectY = dot.y;
						dot.x = Math.min(Math.max(dot.x, 0), c.width);
						dot.y = Math.min(Math.max(dot.y, 0), c.height);
						if(dot.x != reflectX) {
							dot.preX = reflectX;
						}
						if(dot.y != reflectY) {
							dot.preY = reflectY;
						}
						x_list.push(dot.x)
						y_list.push(dot.y)
					});


					max_x = Math.max.apply(null, x_list);
					max_y = Math.max.apply(null, y_list);
					min_x = Math.min.apply(null, x_list);
					min_y = Math.min.apply(null, y_list);
					preCanvas.width = max_x - min_x + r * 2;
					preCanvas.height = max_y - min_y + r * 2;
					min_x -= r;
					min_y -= r;

					springs.forEach(function(spring) {
//						spring.draw(preCtx, min_x, min_y);
					});

					dots.forEach(function(dot){
						dot.draw(preCtx, min_x, min_y);
					});
					res = res.concat(redraw_area);
					res.push(preCanvas, min_x, min_y)
					redraw_area = [min_x - 1, min_y - 1, preCanvas.width + 2, preCanvas.height + 2];
					return res;
				}
				function clickListener(e) {
					var newDot = new Dot(e.offsetX, e.offsetY, r)
					newDot.draw(ctx);
					for(i = 0; i < dot_list.length; i++) {
						spring_list.push(new Spring(dot_list[i], newDot))
					}
					dot_list.push(newDot);
				}
				function init() {
					stop = true;
					frames = [];
					dot_list = [];
					spring_list = [];
					ctx.clearRect(0, 0, c.width, c.height);
					c.addEventListener('click', clickListener);
				}
				function applySpdSetting () {
					dot_list.forEach(function(dot){
						dot.preX -= (form.x_speed.value/1 || 0);
						dot.preY -= (form.y_speed.value/1 || 0);
						dot.aX += form.x_acc.value/1;
						dot.aY += form.y_acc.value/1;
					});
				}
				function anime() {
					if(!stop) {
						if(frames.length >= 7) {
							frames.splice(0, 4);
//							ctx.clearRect.apply(ctx, frames.splice(0, 4));
							ctx.drawImage.apply(ctx, frames.splice(0, 3));
							requestAnimFrame(function(){
								anime()
							});
						}
					} else {
						ctx.clearRect(0, 0, c.width, c.height);
					}
				}
				function drawBuffer(dot_list, spring_list) {
					var i;
					for(i = 0; i < buffer; i ++) {
						frames.push.apply(frames, drawFrame(dot_list, spring_list));
					}
				}
				form.play_btn.addEventListener('click', function(ev) {
					var p;
					ev.preventDefault();
					if(stop) {
						stop = false;
						this.value = 'Reseet';
						c.removeEventListener('click', clickListener);
						applySpdSetting();
						ctx.clearRect(0, 0, c.width, c.height);
						drawBuffer(dot_list, spring_list);
						requestAnimFrame(function(){
							anime()
						});
					} else {
						this.value = 'Play';
						init();
					}
					return false;
				});
				init();
			})()
				
		</script>
	</body>
</html>
